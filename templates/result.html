<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PageSpeed ایران — Detailed Lighthouse Viewer</title>
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
<style>
@font-face {
  font-family: 'Vazir';
  src: url('/static/fonts/Vazir.woff') format('woff');
  font-weight: normal;
  font-style: normal;
}

:root {
  --bg:#061023;
  --panel:#0b1220;
  --card-grad:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  --muted:#9aa8c0;
  --text:#e6eef8;
  --accent:#6750A4;
  --accent-2:#7c4dff;
  --success:#2ecc71;
  --warning:#ffb020;
  --danger:#ff6b6b;
  --glass:rgba(255,255,255,0.03);
  --radius:14px;
  --gap:18px;
  font-family: "Vazir", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  font-size:14px;
}

* {
  box-sizing:border-box;
}

html,
body {
  height:100%;
  margin:0;
  background:linear-gradient(180deg,var(--bg), #04101b);
  color:var(--text);
}

a {
  color:inherit;
  text-decoration:none;
}

.app {
  display:grid;
  grid-template-columns:300px 1fr;
  min-height:100vh;
  gap:0;
}

/* Sidebar */
.sidebar {
  padding:28px 20px;
  background: rgba(255,255,255,0.02);
  border-right: 1px solid rgba(255,255,255,0.03);
}

.brand {
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:12px;
}

.brand .logo {
  width:46px;
  height:46px;
  border-radius:12px;
  background:linear-gradient(135deg,var(--accent),var(--accent-2));
  box-shadow:0 8px 30px rgba(124,77,255,0.12);
}

.brand .title {
  font-weight:800;
  font-size:18px;
}

.small {
  font-size:12px;
  color:var(--muted);
}

.nav {
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top:16px;
}

.nav a {
  padding:10px;
  border-radius:10px;
  color:var(--muted);
  display:flex;
  gap:10px;
  align-items:center;
}

.nav a.active,
.nav a:hover {
  background:rgba(255,255,255,0.02);
  color:var(--text);
}

.quick {
  margin-top:18px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.btn {
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;
  border:none;
  padding:10px 12px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 8px 24px rgba(124,77,255,0.12);
}

.btn-ghost {
  background:transparent;
  border:1px solid rgba(255,255,255,0.04);
  color:var(--text);
}

.header {
  padding:18px 24px;
  border-bottom:1px solid rgba(255,255,255,0.02);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.header .meta {
  display:flex;
  gap:12px;
  align-items:center;
}

.main {
  padding:22px 24px;
}

.grid {
  display:grid;
  grid-template-columns:repeat(12,1fr);
  gap:var(--gap);
}

.card {
  background:var(--card-grad);
  padding:16px;
  border-radius:var(--radius);
  border:1px solid rgba(255,255,255,0.02);
  box-shadow:
    0 12px 40px rgba(0,0,0,0.55),
    inset 0 1px 0 rgba(255,255,255,0.04);
  position: relative;
}

.col-12 { grid-column:span 12; }
.col-8  { grid-column:span 8; }
.col-6  { grid-column:span 6; }
.col-4  { grid-column:span 4; }

.card .section-title {
  font-weight:800;
  margin-bottom:8px;
}

#vitalsCard > div:first-child {
  padding-bottom: 14px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  margin-bottom: 14px;
}

#categoriesCard > div:first-child {
  padding-bottom: 14px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  margin-bottom: 14px;
}

#categoriesCard > div:first-child div:first-child > div:first-child {
  font-size: 15px;
  letter-spacing: .3px;
}

#catTitle {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 4px;
}

#catDesc {
  color: rgba(255,255,255,0.65);
  line-height: 1.6;
}

#catScoreWrap {
  background: rgba(255,255,255,0.04);
  border-radius: 12px;
  padding: 12px;
  border: 1px solid rgba(255,255,255,0.06);
}

#catDesc {
  background: rgba(255,255,255,0.04);
  border-radius: 12px;
  padding: 12px;
  border: 1px solid rgba(255,255,255,0.06);
}

catDescWarp {
  background: rgba(255,255,255,0.04);
  border-radius: 12px;
  padding: 12px;
  border: 1px solid rgba(255,255,255,0.06);
}


.kv {
  color:var(--muted);
  font-size:13px;
}

.gauges {
  display:flex;
  gap:14px;
  align-items:center;
}

.gauge {
  width:110px;
  height:110px;
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
}

.gauge svg {
  transform:rotate(-90deg);
  width:110px;
  height:110px;
}

.gauge .label {
  position:absolute;
  text-align:center;
  font-weight:800;
}

.gauge .label .num {
  font-size:20px;
}

.gauge .label .sub {
  font-size:11px;
  color:var(--muted);
}

.row {
  display:flex;
  gap:12px;
  align-items:center;
}

.audit-list {
  margin-top: 8px;
  background: rgba(255,255,255,0.03);
  border-radius: 14px;
  padding: 10px;

  border: 1px solid rgba(255,255,255,0.05);

  max-height: 500px;        /* سقف ارتفاع */
  overflow-y: auto;
  overflow-x: hidden;
}

.audit {
  padding:12px;
  border-radius:10px;
  background:rgba(255,255,255,0.015);
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:center;
}

.audit .left {
  flex:1;
}

.audit .title {
  font-weight:700;
}

.badge {
  padding:6px 8px;
  border-radius:999px;
  font-weight:700;
  font-size:12px;
}

.filmstrip {
  display:flex;
  gap:10px;
  overflow-x:auto;
  overflow-y:hidden;
  padding:8px 0;
  background:var(--panel);
  border-radius:var(--radius);
  border:1px solid rgba(255,255,255,0.03);
}

.thumb {
  width:160px;
  height:90px;
  border-radius:6px;
  background-size:cover;
  background-position:top;
  flex:0 0 auto;
  border:1px solid rgba(255,255,255,0.03);
}

.tabs {
  display: flex;
  gap: 6px;
  padding: 4px;
  background: rgba(255,255,255,0.04);
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.06);
}

.tabs button {
  all: unset;
  cursor: pointer;
  padding: 6px 14px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 999px;
  color: rgba(255,255,255,0.6);
  transition: all .25s ease;
}

.tabs button:hover {
  color: #fff;
}

.tabs button.active {
  background: linear-gradient(
    135deg,
    #6366f1,
    #22d3ee
  );
  color: #020617;
  box-shadow:
    0 6px 18px rgba(99,102,241,0.45);
}


textarea#raw {
  width:100%;
  height:260px;
  background:#071124;
  color:var(--text);
  border-radius:8px;
  padding:12px;
  border:1px solid rgba(255,255,255,0.03);
  resize:vertical;
}

.sep {
  height: 1px;
  background: linear-gradient(
    to right,
    transparent,
    rgba(255,255,255,0.12),
    transparent
  );
  margin: 18px 0;
}


.legend {
  display:flex;
  gap:8px;
  align-items:center;
}

.legend .item {
  display:flex;
  gap:6px;
  align-items:center;
  color:var(--muted);
  font-size:13px;
}

@media (max-width:1000px) {
  .app {
    grid-template-columns:1fr;
  }

  .col-4,
  .col-6,
  .col-8 {
    grid-column:span 12;
  }

  .sidebar {
    position:sticky;
    top:0;
    padding:12px;
    display:flex;
    flex-direction:row;
    gap:12px;
    overflow:auto;
  }

  .brand {
    display:none;
  }

  .gauges {
    flex-wrap:wrap;
  }

  .gauge {
    width:86px;
    height:86px;
  }
}

.thumb-wrap {
  width:120px;
  text-align:center;
}

.thumb {
  width:100%;
  height:80px;
  border-radius:6px;
}

.thumb-time {
  margin-top:4px;
  font-size:12px;
  color:#b9b8b8;
}

@media (max-width:1000px) {
  .app {
    grid-template-columns:1fr;
  }

  .sidebar {
    position:fixed;
    top:0;
    right:-320px;
    width:300px;
    height:100%;
    background:rgba(255,255,255,0.02);
    z-index:1000;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow-y:auto;
    transition:right 0.3s ease;
  }
}

#testMeta {
  white-space:pre-line;
  color:var(--muted);
  font-size:13px;
}

.metadata-grid {
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:12px 18px;
}

.meta-item {
  position:relative;
  padding-right:20px;
  cursor:default;
  color:var(--muted);
  font-size:13px;
}

.meta-item .tooltip {
  visibility:hidden;
  opacity:0;
  width:200px;
  background-color:rgba(0,0,0,0.75);
  color:#fff;
  text-align:left;
  border-radius:6px;
  padding:6px 8px;
  position:absolute;
  z-index:10;
  bottom:100%;
  left:0;
  margin-bottom:6px;
  font-size:12px;
  transition:opacity 0.2s;
}

.meta-item:hover .tooltip {
  visibility:visible;
  opacity:1;
}

/* Tabs tweaks */
.tabs {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  padding:4px;
  background:rgba(255,255,255,0.02);
  border-radius:12px;
}

.tab {
  position:relative;
  padding:10px 14px;
  border-radius:10px;
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.05);
  cursor:pointer;
  color:var(--muted);
  font-weight:700;
  transition:all .2s ease;
}

.tab:hover {
  color:var(--text);
  border-color:rgba(124,77,255,0.5);
  box-shadow:0 0 0 2px rgba(124,77,255,0.15);
  transform:translateY(-1px);
}

.tab.active {
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;
  border-color:transparent;
  box-shadow:0 8px 26px rgba(124,77,255,0.35);
}

.tab.active::after {
  content:'';
  position:absolute;
  left:20%;
  right:20%;
  bottom:-6px;
  height:3px;
  border-radius:999px;}

/* Audit item tweaks */
.audit .title {
  font-weight:700;
  margin-bottom:4px;
}

.audit .kv {
  color:var(--muted);
  font-size:13px;
}

.audit-list::-webkit-scrollbar {
  height:6px;
  width:6px;
}

.audit-list::-webkit-scrollbar-thumb {
  background:rgba(255,255,255,0.03);
  border-radius:6px;
}

/* Category score wrapper small */
#catScoreWrap .gauge {
  display:inline-block;
  vertical-align:middle;
  margin-right:8px;
}

#catScoreWrap div:last-child {
  display:inline-block;
  vertical-align:middle;
  font-weight:800;
  margin-left:6px;
  color:var(--text);
}

#catTitle,
#catDesc,
#opportunities,
#diagnostics {
  animation:fadeSlide .25s ease;
}

@keyframes fadeSlide {
  from {
    opacity:0;
    transform:translateY(4px);
  }
  to {
    opacity:1;
    transform:translateY(0);
  }
}
</style>

</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title">PageSpeed ایران</div>
        <div class="small">Lighthouse viewer — کامل و مرتب</div>
      </div>
    </div>
    <nav class="nav" aria-label="Primary">
      <a href="#" class="active">داشبورد</a>
      <a href="#">تست جدید</a>
      <a href="#">تاریخچه</a>
      <a href="#">API</a>
      <a href="#">درباره</a>
    </nav>
    <div class="quick">
      <button id="copyJsonBtn" class="btn-ghost">کپی JSON</button>
      <button id="downloadJsonBtn" class="btn-ghost">دانلود JSON</button>
    </div>
    <div style="margin-top:18px" class="small">راهنما</div>
    <div class="kv" style="margin-top:8px">این داشبورد پذیرای JSON کامل Lighthouse است؛ نتایج با رنگ و بخش‌بندی مشابه نسخهٔ رسمی نمایش داده می‌شوند.</div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="header card">
      <div class="meta">
        <div style="font-weight:800">نتیجه PageSpeed</div>
        <div class="kv" id="metaUrl">—</div>
      </div>
      <div class="row">
        <div class="kv" id="fetchTime">—</div>
        <div class="legend">
          <div class="item"><span style="width:12px;height:12px;border-radius:3px;background:var(--success);display:inline-block"></span> خوب</div>
          <div class="item"><span style="width:12px;height:12px;border-radius:3px;background:var(--warning);display:inline-block"></span> نیاز به بهبود</div>
          <div class="item"><span style="width:12px;height:12px;border-radius:3px;background:var(--danger);display:inline-block"></span> بحرانی</div>
        </div>
      </div>
    </div>

    <section class="grid" style="margin-top:18px">
      <div class="card col-8" id="overviewCard">
        <div class="section-title">Overview</div>
        <div id="gauges" class="gauges"></div>
      </div>

      <div class="card col-4">
        <div style="font-weight:700">Resource summary</div>
        <div id="resourceSummary" class="kv">—</div>
        <div id="totalBytes" class="kv">—</div>
      </div>

      <div class="card col-12" id="vitalsCard">
        <div style="font-weight:700;margin-bottom:12px">Core Web Vitals و متریک‌های اضافی</div>
        <div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap">

          <div class="card" style="flex:1;padding:10px">
            <div style="font-weight:700">First Contentful Paint (FCP)</div>
            <div id="fcp" class="kv" style="font-weight:800">—</div>
            <div style="margin-top:6px;font-size:12px;color:var(--muted)">
              زمان بارگذاری اولین متن یا تصویر صفحه.
            </div>
          </div>

          <div class="card" style="flex:1;padding:10px">
            <div style="font-weight:700">Largest Contentful Paint (LCP)</div>
            <div id="lcp" class="kv" style="font-weight:800">—</div>
            <div style="margin-top:6px;font-size:12px;color:var(--muted)">
              زمان بارگذاری بزرگ‌ترین متن یا تصویر قابل مشاهده.
            </div>
          </div>

          <div class="card" style="flex:1;padding:10px">
            <div style="font-weight:700">Total Blocking Time (TBT)</div>
            <div id="tbt" class="kv" style="font-weight:800">—</div>
            <div style="margin-top:6px;font-size:12px;color:var(--muted)">
              مجموع زمان‌های بین FCP و زمان تعاملی بودن صفحه که پردازش طولانی‌تر از ۵۰ میلی‌ثانیه بوده.
            </div>
          </div>

          <div class="card" style="flex:1;padding:10px">
            <div style="font-weight:700">Cumulative Layout Shift (CLS)</div>
            <div id="cls" class="kv" style="font-weight:800">—</div>
            <div style="margin-top:6px;font-size:12px;color:var(--muted)">
              میزان تغییرات ناگهانی المان‌های قابل مشاهده در صفحه.
            </div>
          </div>

          <div class="card" style="flex:1;padding:10px">
            <div style="font-weight:700">Speed Index</div>
            <div id="speedIndex" class="kv" style="font-weight:800">—</div>
            <div style="margin-top:6px;font-size:12px;color:var(--muted)">
              سرعت نمایش محتوای صفحه به کاربر.
            </div>
          </div>

        </div>

        <!-- Metadata Block -->
        <!--div class="card" style="margin-top:12px; padding:10px;">
          <div class="metadata-grid" style="display:flex; flex-wrap:wrap; gap:12px;">
            
            <div class="meta-item">
              Captured at Dec 1, 2025, 1:47 AM GMT+3:30
              <span class="tooltip">زمان دقیق اجرای تست</span>
            </div>

            <div class="meta-item">
              Emulated Desktop with Lighthouse 13.0.1
              <span class="tooltip">نوع دستگاه شبیه‌سازی شده و نسخه Lighthouse</span>
            </div>

            <div class="meta-item">
              Single page session
              <span class="tooltip">جلسه یک صفحه‌ای برای تست</span>
            </div>

            <div class="meta-item">
              Initial page load
              <span class="tooltip">نوع بارگذاری اولیه صفحه</span>
            </div>

            <div class="meta-item">
              Custom throttling
              <span class="tooltip">تنظیمات شبیه‌سازی شبکه و CPU</span>
            </div>

            <div class="meta-item">
              Using HeadlessChromium 137.0.7151.119 with lr
              <span class="tooltip">مرورگر Headless که تست با آن انجام شده</span>
            </div>

          </div>
        </div-->

        <div style="font-weight:700;margin-bottom:8px; margin-top: 8px;">Filmstrip</div>
        <div class="filmstrip" id="filmstrip"></div>
      </div>



      <div class="card col-12" id="categoriesCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">Categories</div>
            <div class="kv" style="margin-bottom:6px">
              برای مشاهده جزئیات، روی دسته‌ها کلیک کنید
            </div>
          </div>
          <div class="tabs" id="categoryTabs" role="tablist">
            <!-- تب‌ها با JS ساخته می‌شوند -->
          </div>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:space-between;gap:18px;align-items:center">
          <div id ="catDescWarp" style="flex:1; margin-right: 6px;">
            <div id="catTitle" class="kv" style="font-weight:700">—</div>
            <div id="catDesc" class="kv">—</div>
          </div>

          <div style="width:360px">
            <!--div style="font-weight:700">Category Score</div-->
            <div id="catScoreWrap" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="sep"></div>

        <div style="display:grid;grid-template-columns:1fr 360px;gap:18px">
          <div>
            <div style="font-weight:700">Opportunities</div>
            <div class="audit-list" id="opportunities"></div>
          </div>

          <div>
            <div style="font-weight:700">Diagnostics</div>
            <div class="audit-list" id="diagnostics"></div>
          </div>
        </div>
      </div>

      <div class="card col-4">
        <div style="font-weight:700">Render-blocking / Savings</div>
        <div class="audit-list" id="renderBlocking" class="kv">—</div>
      </div>

      <div class="card col-4">
        <div style="font-weight:700">Unused CSS</div>
        <div class="audit-list" id="unusedCss" class="kv">—</div>
      </div>

      <div class="card col-4">
        <div style="font-weight:700">Passed audits (نمونه)</div>
        <div class="audit-list" id="passed"></div>
      </div>

      <div class="card col-12">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Raw JSON</div>
        </div>
        <textarea id="raw" readonly></textarea>
      </div>
    </section>
</main>
</div>

<script>
// --------------------- Helpers ------------------------
function clamp(n,a,b){return Math.max(a,Math.min(b,n));}

function scoreColor(score){
  if(score==null) return 'var(--muted)';
  if(score>=90) return 'var(--success)';
  if(score>=50) return 'var(--warning)';
  return 'var(--danger)';
}

function makeGauge(score,size=110){
  const r=36,c=2*Math.PI*r,v=clamp(Math.round(score),0,100),offset=c*(1-v/100);
  const color=scoreColor(score);
  return `<div class="gauge" title="${v}">
    <svg viewBox="0 0 100 100" width="${size}" height="${size}">
      <circle cx="50" cy="50" r="${r}" stroke="rgba(255,255,255,0.06)" stroke-width="10" fill="none"></circle>
      <circle cx="50" cy="50" r="${r}" stroke="${color}" stroke-width="10" fill="none"
        stroke-dasharray="${c}" stroke-dashoffset="${offset}" stroke-linecap="round"></circle>
    </svg>
    <div class="label"><div class="num">${v}</div><div class="sub">score</div></div>
  </div>`;
}

function safeText(s){return s==null?'—':String(s);}
function bytesToKB(b){return b==null?'—':(b/1024).toFixed(1)+' KB';}

function auditSeverity(a){
  if(a.scoreDisplayMode==='notApplicable') return {label:'N/A', color:'var(--muted)'};
  if(a.scoreDisplayMode==='informative') return {label:'Info', color:'var(--muted)'};
  if(typeof a.score==='number'){
    if(a.score>=0.9) return {label:'Good', color:'var(--success)'};
    if(a.score>=0.5) return {label:'Needs work', color:'var(--warning)'};
    return {label:'Fail', color:'var(--danger)'};
  }
  if(a.details?.type==='opportunity' || a.scoreDisplayMode==='metricSavings') return {label:'Opportunity', color:'var(--warning)'};
  return {label:'—', color:'var(--muted)'};
}

// --------------------- Main Render ---------------------
function renderAll(res){
  if(!res?.lighthouseResult) return console.error('Invalid Lighthouse JSON');
  const LR=res.lighthouseResult;
  const cats=LR.categories||{}, audits=LR.audits||{};

  // Meta
  document.getElementById('metaUrl').innerText=res.finalUrl||LR.finalUrl||LR.requestedUrl||'—';
  document.getElementById('fetchTime').innerText=LR.fetchTime?new Date(LR.fetchTime).toLocaleString():'—';

  // Gauges
  const gaugeMap=[{k:'performance',title:'Performance'},{k:'accessibility',title:'Accessibility'},{k:'best-practices',title:'Best Practices'},{k:'seo',title:'SEO'}];
  const gaugesWrap=document.getElementById('gauges'); 
  gaugesWrap.innerHTML='';
  gaugeMap.forEach(g=>{
    const scoreRaw=cats[g.k]?.score;
    const score=scoreRaw!=null?scoreRaw*100:null;
    const div=document.createElement('div'); 
    div.style.textAlign='center';
    div.innerHTML=makeGauge(score)+`<div style="margin-top:6px;font-weight:700">${g.title}</div>`;
    gaugesWrap.appendChild(div);
  });

  // Core Web Vitals
  function scoreColorMetric(v, id){
    if(v==null) return 'var(--muted)';
    switch(id){
      case 'cls': return v<=0.1?'var(--success)':v<=0.25?'var(--warning)':'var(--danger)';
      case 'tbt': return v<=200?'var(--success)':v<=600?'var(--warning)':'var(--danger)';
      case 'lcp':
      case 'fcp':
      case 'speedIndex': return v<=1800?'var(--success)':v<=3000?'var(--warning)':'var(--danger)';
      default: return scoreColor(v);
    }
  }

  function setMetric(id, display, num){
    const el=document.getElementById(id);
    el.innerText=display|| (num!=null?Math.round(num):'—');
    el.style.color=num!=null?scoreColorMetric(num,id):'var(--muted)';
  }

  setMetric('lcp', audits['largest-contentful-paint']?.displayValue, audits['largest-contentful-paint']?.numericValue);
  setMetric('fcp', audits['first-contentful-paint']?.displayValue, audits['first-contentful-paint']?.numericValue);
  setMetric('cls', audits['cumulative-layout-shift']?.displayValue, audits['cumulative-layout-shift']?.numericValue);
  setMetric('tbt', audits['total-blocking-time']?.displayValue, audits['total-blocking-time']?.numericValue);
  setMetric('speedIndex', audits['speed-index']?.displayValue, audits['speed-index']?.numericValue);

  // Filmstrip
  const filmEl = document.getElementById('filmstrip');
  filmEl.innerHTML = '';

  const shots =
    audits['screenshot-thumbnails']?.details?.items ||
    (LR.fullPageScreenshot?.screenshot
      ? [LR.fullPageScreenshot.screenshot]
      : []);

  if (shots.length) {
    shots.slice(0, 8).forEach(it => {
      const data = it.data || it.screenshot || it;
      const timing = it.timing ?? it.timestamp ?? null; // ms

      const wrap = document.createElement('div');
      wrap.className = 'thumb-wrap';

      const d = document.createElement('div');
      d.className = 'thumb';
      d.style.backgroundImage = `url(${data})`;
      d.style.backgroundPosition = 'top';
      d.style.backgroundSize = 'cover';

      const t = document.createElement('div');
      t.className = 'thumb-time';
      t.textContent = timing !== null
        ? `${(timing / 1000).toFixed(2)}s`
        : '';

      wrap.appendChild(d);
      wrap.appendChild(t);
      filmEl.appendChild(wrap);
    });
  } else {
    filmEl.innerHTML = '<div class="kv">No screenshots</div>';
  }


  // Resource Summary
  const rsItems=audits['resource-summary']?.details?.items||[];
  const rsWrap=document.getElementById('resourceSummary'); 
  rsWrap.innerHTML='';
  if(rsItems.length){
    rsItems.forEach(it=>{
      rsWrap.innerHTML+=`<div style="display:flex;justify-content:space-between">
        <div class="kv">${it.label}</div>
        <div class="kv">${it.requestCount} req — ${bytesToKB(it.transferSize)}</div>
      </div>`;
    });
    document.getElementById('totalBytes').innerText='Total: '+bytesToKB(rsItems.reduce((s,x)=>s+x.transferSize,0));
  } else { rsWrap.innerText='—'; document.getElementById('totalBytes').innerText='—'; }

  // Audit Renderer
  function renderAudits(list, container){
    container.innerHTML='';
    if(!list.length){ container.innerHTML='<div class="kv">No items</div>'; return; }
    list.forEach(a=>{
      const val=a.displayValue || (a.details?.overallSavingsMs?`~ ${a.details.overallSavingsMs} ms`:'');
      const sev=auditSeverity(a);
      const node=document.createElement('div'); node.className='audit';
      node.innerHTML=`
        <div class="left">
          <div class="title">${a.title||a.id}</div>
          <div class="kv">${a.description||''}</div>
        </div>
        <div style="text-align:left">
          <div style="margin-bottom:6px">${val}</div>
          <div class="badge" style="background:${sev.color};color:#06121a">${sev.label}</div>
        </div>`;
      container.appendChild(node);
    });
  }

  // Small panels: Render-blocking
  const rb = audits['render-blocking-insight'] || audits['render-blocking-resources'];
  const rbEl = document.getElementById('renderBlocking'); rbEl.innerHTML = '';
  if(rb?.details?.items?.length){
    rb.details.items.slice(0,10).forEach(it=>{
      const node = document.createElement('div'); 
      node.className = 'audit';
      node.innerHTML = `
        <div class="left">
          <div class="title">${it.url}</div>
          <div class="kv">Total: ${bytesToKB(it.totalBytes)} — wasted: ${it.wastedMs||0} ms</div>
        </div>`;
      rbEl.appendChild(node);
    });
  } else if(rb?.displayValue){
    rbEl.innerHTML = `<div class="kv">${rb.displayValue}</div>`;
  } else { rbEl.innerHTML = '<div class="kv">—</div>'; }

  // Unused CSS
  const ucss = audits['unused-css-rules']; const ucssEl = document.getElementById('unusedCss'); ucssEl.innerHTML='';
  if(ucss?.details?.items?.length){
    ucss.details.items.forEach(it=>{
      const node = document.createElement('div'); 
      node.className = 'audit';
      node.innerHTML = `<div class="left"><div class="title">${it.url}</div><div class="kv">Total: ${bytesToKB(it.totalBytes)} — wasted: ${bytesToKB(it.wastedBytes)}</div></div>`;
      ucssEl.appendChild(node);
    });
  } else if(ucss?.displayValue){
    ucssEl.innerHTML = `<div class="kv">${ucss.displayValue}</div>`;
  } else if(ucss?.overallSavingsBytes){
    ucssEl.innerHTML = `<div class="kv">Savings: ${bytesToKB(ucss.overallSavingsBytes)}</div>`;
  } else { ucssEl.innerHTML = '<div class="kv">—</div>'; }

  // Passed Audits
  const passed=document.getElementById('passed'); passed.innerHTML='';
  Object.values(audits).forEach(a=>{
    if(a.score===1 || a.scoreDisplayMode==='notApplicable'){
      const sev=auditSeverity(a);
      const node=document.createElement('div'); node.className='audit';
      node.innerHTML=`<div class="left"><div class="title">${a.title||a.id}</div><div class="kv">${a.displayValue||a.description||''}</div></div><div style="color:${sev.color}">✔</div>`;
      passed.appendChild(node);
    }
  });
  if(!passed.children.length) passed.innerHTML='<div class="kv">No passed audits</div>';

  // Categories
  (function setupCategories(){
    const tabs=document.getElementById('categoryTabs'); tabs.innerHTML='';
    const catKeys=Object.keys(cats).length ? Object.keys(cats) : ['performance','accessibility','best-practices','seo','pwa'];
    const preferred=['performance','accessibility','best-practices','seo','pwa'];
    const ordered = preferred.filter(k=>catKeys.includes(k)).concat(catKeys.filter(k=>!preferred.includes(k)));

    ordered.forEach((k,i)=>{
      const b=document.createElement('button'); b.className='tab'+(i===0?' active':''); b.dataset.cat=k; b.innerText=cats[k]?.title || k.toUpperCase();
      b.onclick=()=>{ document.querySelectorAll('#categoryTabs .tab').forEach(t=>t.classList.remove('active')); b.classList.add('active'); showCat(k); };
      tabs.appendChild(b);
    });

    function showCat(k){
      const cat=cats[k] || {title:k, description:''};
      document.getElementById('catTitle').innerText=cat.title;
      document.getElementById('catDesc').innerText=cat.description;
      const score=Math.round((cat.score!=null?cat.score:0)*100);
      document.getElementById('catScoreWrap').innerHTML = makeGauge(score,80)+`<div style="margin-top:8px">${score}</div>`;

      const ids=(cat.auditRefs||[]).map(r=>r.id).filter(Boolean);
      let list=ids.map(id=>audits[id]).filter(Boolean);

      let opp=list.filter(a=>a.details?.type==='opportunity' || a.scoreDisplayMode==='metricSavings');
      let diag=list.filter(a=>['informative','manual','notApplicable'].includes(a.scoreDisplayMode) || (typeof a.score!=='number' && a.details?.type!=='opportunity'));

      if(!ids.length){
        const key=k.toLowerCase();
        const all=Object.values(audits);
        opp=all.filter(a=>(a.details?.type==='opportunity' || a.scoreDisplayMode==='metricSavings') && ((a.id||'').toLowerCase().includes(key)));
        diag=all.filter(a=>(['informative','manual','notApplicable'].includes(a.scoreDisplayMode)) && ((a.id||'').toLowerCase().includes(key)));
      }

      opp.sort((A,B)=>((B.details?.overallSavingsMs||0)+(B.details?.overallSavingsBytes||0))-((A.details?.overallSavingsMs||0)+(A.details?.overallSavingsBytes||0)));
      diag.sort((A,B)=>(A.id||'').localeCompare(B.id||''));
      renderAudits(opp,document.getElementById('opportunities'));
      renderAudits(diag,document.getElementById('diagnostics'));
      if(!opp.length) document.getElementById('opportunities').innerHTML='<div class="kv">No opportunities</div>';
      if(!diag.length) document.getElementById('diagnostics').innerHTML='<div class="kv">No diagnostics</div>';
    }

    showCat(ordered[0]||'performance');
  })();

  // Raw JSON
  const raw=document.getElementById('raw'); raw.value=JSON.stringify(res,null,2);
  document.getElementById('copyJsonBtn').onclick=()=>navigator.clipboard.writeText(JSON.stringify(res,null,2)).then(()=>alert('JSON کپی شد'));
  document.getElementById('downloadJsonBtn').onclick=()=>{
    const blob=new Blob([JSON.stringify(res,null,2)],{type:'application/json'}); 
    const url=URL.createObjectURL(blob); 
    const a=document.createElement('a'); a.href=url; a.download='pagespeed-result.json'; a.click(); 
    URL.revokeObjectURL(url);
  };
}


// --------------------- RUN ---------------------
{% if result_data %}
const pagespeedData = {{ result_data|safe }};
renderAll(pagespeedData);
{% endif %}
</script>


</body>
</html>
